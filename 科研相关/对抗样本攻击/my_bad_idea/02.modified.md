

好的，我来为你重新编写一份经过修正的、严谨的完整 README 文档。

---

## Randomized Orthogonal Path Folding for Adversarial Purification (ROPF)

## 基于随机正交路径折叠的对抗净化

---

## 1. 研究动机

### 1.1 问题背景

基于扩散模型 / Flow 模型的对抗净化（如 DiffPure）是当前最有前景的对抗防御范式之一。其核心思想是：将对抗样本通过生成模型的前向加噪过程"模糊化"，再通过反向去噪过程重建干净图像，从而消除对抗扰动。

然而，现有方法面临两个根本性的白盒攻击威胁：

| 攻击手段 | 原理 | 针对的防御弱点 |
|---------|------|-------------|
| Adjoint Method | 沿固定 ODE 轨迹反向传播，精确计算梯度 | ODE 轨迹固定且连续，梯度可解析传播 |
| EOT (Expectation Over Transformation) | 对防御中的随机性多次采样求期望梯度 | 随机性维度低（如 SDE 中的高斯噪声），蒙特卡洛估计快速收敛 |

### 1.2 核心洞察

Flow Matching / Rectified Flow 的一个关键优势是**概率路径的灵活性**。预训练模型学到的向量场 $v_\theta(x_t, t)$ 定义在数据空间的边缘分布 $p_t$ 上。如果我们能在推理时**改变 ODE 的求解路径**，同时**保证网络输入始终落在原始训练分布上**，就能在不损失净化质量的前提下引入攻击者无法穿透的随机性。

**本方案的核心思想**：通过分段正交变换（Piecewise Orthogonal Transformation），将原始的直线 ODE 轨迹"折叠"到一个高维的变换空间中。由于正交变换的保距性质，预训练向量场可以被完美复用；由于变换的高维随机性，攻击者的 EOT 所需采样数指数级增长，在计算上不可行。

---

## 2. 数学框架

### 2.1 基准系统：预训练 Flow 模型

设预训练的 Rectified Flow / CNF 模型定义了向量场 $v_\theta(x_t, t)$，其标准 ODE 为：

$$\frac{dx_t}{dt} = v_\theta(x_t, t), \quad t: 1 \to 0$$

其中 $x_1 \sim \mathcal{N}(0, I)$（噪声），$x_0 \sim p_{data}$（干净图像）。

### 2.2 变换空间的构建

#### 2.2.1 Patch-wise 正交变换算子

由于全图维度的正交矩阵（如 $3 \times 256 \times 256 = 196608$ 维）在存储和计算上不可行，我们采用 **Patch-wise 分块正交变换**。

设图像尺寸为 $C \times H \times W$，patch 大小为 $p \times p$。

**Step 1**：将图像切分为 $M = \frac{H}{p} \times \frac{W}{p}$ 个不重叠的 patch。

**Step 2**：将每个 patch 展平为 $d = C \times p \times p$ 维向量。

**Step 3**：为每个 patch 独立生成一个 $d \times d$ 的随机正交矩阵 $R_k^{(m)}$，其中 $k$ 为时间段索引，$m$ 为 patch 索引。

正交矩阵的生成方法：
1. 采样随机矩阵 $Z \in \mathbb{R}^{d \times d}$，其中 $Z_{ij} \sim \mathcal{N}(0, 1)$
2. 进行 QR 分解：$Z = QR$
3. 令 $R_k^{(m)} = Q \cdot \text{diag}(\text{sign}(\text{diag}(R)))$，确保 $\det = +1$

**维度与安全性分析**：

| Patch 大小 $p$ | 每 patch 维度 $d$ | 每个 $R$ 的自由度 $\frac{d(d-1)}{2}$ | Patch 数量 $M$（256×256图像） | 单次跳跃总自由度 |
|---------------|-----------------|-------------------------------------|---------------------------|-------------|
| $4 \times 4$ | 48 | 1,128 | 4,096 | 4,620,288 |
| $8 \times 8$ | 192 | 18,336 | 1,024 | 18,776,064 |
| $16 \times 16$ | 768 | 294,528 | 256 | 75,399,168 |

#### 2.2.2 定义变换空间状态

定义正交变换算子 $\mathcal{R}_k$ 为作用在整张图像上的分块对角正交变换：

$$\mathcal{R}_k(x) = \text{BlockDiag}(R_k^{(1)}, R_k^{(2)}, \dots, R_k^{(M)}) \cdot \text{Reshape}(x)$$

其逆变换为：

$$\mathcal{R}_k^T(y) = \text{BlockDiag}({R_k^{(1)}}^T, {R_k^{(2)}}^T, \dots, {R_k^{(M)}}^T) \cdot \text{Reshape}(y)$$

定义变换空间状态：

$$y_t \triangleq \mathcal{R}_k(x_t)$$

### 2.3 变换空间中的 ODE 演化

在时间区间 $(t_k, t_{k+1})$ 内，$\mathcal{R}_k$ 保持不变。对 $y_t$ 求时间导数：

$$\frac{dy_t}{dt} = \mathcal{R}_k\left(\frac{dx_t}{dt}\right) = \mathcal{R}_k\left(v_\theta(x_t, t)\right) = \mathcal{R}_k\left(v_\theta(\mathcal{R}_k^T(y_t), t)\right)$$

**关键性质**：网络 $v_\theta$ 的输入为 $\mathcal{R}_k^T(y_t) = x_t$，始终处于预训练模型的原始数据分布上。因此：

- ✅ 预训练模型被**完美复用**，无需任何微调
- ✅ 正交变换是保距的，不引入数值误差
- ✅ 净化质量与原始 Flow purification 理论上完全一致

### 2.4 时间跳跃点的状态转换

将去噪时间 $[t_{start}, 0]$ 划分为 $K$ 个区间，跳跃时间点为 $\{\tau_1, \tau_2, \dots, \tau_{K-1}\}$。

在跳跃点 $\tau_i$，正交算子从 $\mathcal{R}_{old}$ 切换为 $\mathcal{R}_{new}$。变换空间中的状态转换为：

$$y_{\tau_i}^{after} = \mathcal{R}_{new}\left(\mathcal{R}_{old}^T(y_{\tau_i}^{before})\right)$$

**注意**：在真实数据空间 $X$ 中，$x_t$ 在跳跃点前后是**完全连续的**：

$$\mathcal{R}_{old}^T(y_{\tau_i}^{before}) = x_{\tau_i} = \mathcal{R}_{new}^T(y_{\tau_i}^{after})$$

因此 ODE 求解器的数值精度不受跳跃影响。跳跃仅发生在变换空间的坐标系层面。

### 2.5 对白盒攻击的防御分析

#### 2.5.1 对 Adjoint Method 的防御

Adjoint Method 要求系统状态在时间上满足 Lipschitz 连续性。变换空间中的跳跃 $y_{\tau_i}^{after} = \mathcal{R}_{new}(\mathcal{R}_{old}^T(y_{\tau_i}^{before}))$ 引入了不连续的坐标系切换，破坏了变换空间中 ODE 轨迹的连续性，导致标准的连续时间反向传播（如 `torchdiffeq.odeint_adjoint`）无法直接应用。

#### 2.5.2 对 BPDA 的防御

BPDA 攻击者用恒等映射 $\mathcal{R}_k = \mathcal{I}$ 近似正交变换来计算梯度。但在高维空间中，随机正交矩阵与单位矩阵之间的"距离"极大。BPDA 估计的梯度方向与真实梯度方向几乎正交，攻击效力趋近于零。

**定量分析**：在 $d$ 维空间中，两个独立随机单位向量的余弦相似度的标准差为 $O(1/\sqrt{d})$。当 $d = 192$（$8 \times 8$ patch）时，BPDA 梯度与真实梯度的相关性约为 $O(1/\sqrt{192}) \approx 0.07$，几乎完全不相关。

#### 2.5.3 对 EOT 的防御

EOT 攻击者通过多次采样估计期望梯度：

$$\hat{g}_{EOT} = \frac{1}{N}\sum_{i=1}^{N} \nabla_{x} \mathcal{L}(f(x; \mathcal{R}^{(i)}))$$

**重要澄清**：由于分类损失函数 $\mathcal{L}$ 是有界的，即使正交变换的参数空间具有复杂的几何结构，期望梯度 $\mathbb{E}_{\mathcal{R}}[\nabla_x \mathcal{L}]$ 在理论上**是良定义的、有限的**。我们**不声称** EOT 的期望不存在。

我们的防御论点是**计算复杂度**层面的：

- 每次 EOT 采样需要完整求解一次 ODE（如 20 步 Euler），计算代价高昂
- 不同随机正交变换产生的梯度方向在高维空间中近似正交，导致 EOT 估计的方差极大
- 要获得方向足够准确的期望梯度，所需采样数 $N$ 随正交变换的总自由度增长

**EOT 收敛性的非正式估计**：

设总自由度为 $D_{total}$（单次跳跃自由度 $\times$ 跳跃次数 $K$）。EOT 估计梯度方向与真实期望梯度方向的余弦相似度满足：

$$\cos(\hat{g}_{EOT}, g_{true}) \lesssim \sqrt{\frac{C}{N}}$$

其中 $C$ 是与梯度方差相关的常数，该常数随 $D_{total}$ 增大而增大。在 $8 \times 8$ patch、$K=5$ 次跳跃的配置下，$D_{total} \approx 9.4 \times 10^7$，使得 EOT 在合理计算预算内（如 $N \leq 10^4$）难以获得有效的攻击梯度。

---

## 3. 完整算法

### 3.1 推理时净化算法 (Inference-time Purification)

```
Algorithm: ROPF Purification
═══════════════════════════════════════════════════════════

Input:
  - x_adv          : 对抗样本
  - v_θ            : 预训练 Flow 模型的向量场
  - t_start        : 加噪起始时间 (如 0.3)
  - N_steps        : ODE 求解步数 (如 20)
  - p              : patch 大小 (如 8)
  - K              : 跳跃次数 (如 5)
  - seed           : 防御方私有随机种子

Output:
  - x_clean        : 净化后的干净图像

═══════════════════════════════════════════════════════════

Step 1: 前向加噪
  ε ~ N(0, I)
  x_start = (1 - t_start) * x_adv + t_start * ε

Step 2: 初始化变换空间
  使用 seed 初始化随机数生成器 RNG
  生成跳跃时间点 {τ_1, ..., τ_{K-1}} (在 [t_start, 0] 内均匀或随机分布)
  生成初始 patch-wise 正交算子 R_curr (使用 RNG)
  y = R_curr(x_start)                    // 进入变换空间

Step 3: ODE 求解循环
  dt = t_start / N_steps
  t = t_start

  for step = 1 to N_steps:

      // 检查是否到达跳跃点
      if t crosses any τ_i:
          生成新的 patch-wise 正交算子 R_new (使用 RNG)
          y = R_new(R_curr^T(y))          // 坐标系跳跃
          R_curr = R_new

      // 复用预训练向量场
      x_eval = R_curr^T(y)               // 解密：变换空间 → 数据空间
      v_pred = v_θ(x_eval, t)            // 网络前向传播（输入在原始分布上）
      v_y = R_curr(v_pred)               // 加密：数据空间 → 变换空间

      // Euler 更新
      y = y - dt * v_y
      t = t - dt

Step 4: 终局解密
  x_clean = R_curr^T(y)                  // 离开变换空间，回到数据流形

Step 5: 输出
  return x_clean
```

### 3.2 Patch-wise 正交矩阵生成算法

```
Algorithm: Generate Patch-wise Orthogonal Operator
═══════════════════════════════════════════════════════════

Input:
  - image_shape    : (C, H, W)
  - patch_size     : p
  - rng            : 随机数生成器实例

Output:
  - R              : patch-wise 正交变换算子 (含 forward 和 inverse 方法)

═══════════════════════════════════════════════════════════

d = C * p * p                             // 每个 patch 的展平维度
M = (H // p) * (W // p)                   // patch 总数

for m = 1 to M:
    Z = rng.randn(d, d)                   // 采样随机矩阵
    Q, R_qr = QR_decomposition(Z)         // QR 分解
    D = sign(diag(R_qr))                  // 确保 det(Q) = +1
    R^(m) = Q * D                         // 标准化正交矩阵

return BlockDiagonalOperator(R^(1), ..., R^(M))
```

### 3.3 正交算子的 Forward / Inverse 操作

```
Forward: R(x)
═══════════════════════════════════════════════════════════
  1. x: (C, H, W) → 切分为 M 个 patch → 每个 patch 展平为 d 维向量
  2. 对第 m 个 patch: y^(m) = R^(m) @ x^(m)
  3. 将所有 y^(m) 重组为 (C, H, W) 形状
  return y

Inverse: R^T(y)
═══════════════════════════════════════════════════════════
  1. y: (C, H, W) → 切分为 M 个 patch → 每个 patch 展平为 d 维向量
  2. 对第 m 个 patch: x^(m) = R^(m)^T @ y^(m)
  3. 将所有 x^(m) 重组为 (C, H, W) 形状
  return x
```

---

## 4. 方案特性总结

### 4.1 核心优势

| 特性 | 说明 |
|------|------|
| **即插即用** | 纯推理时防御，不修改预训练模型的任何参数、架构或训练数据 |
| **完美复用** | 正交变换保证网络输入始终在原始训练分布上，净化质量零损失 |
| **高维随机性** | Patch-wise 正交变换提供 $10^6 \sim 10^7$ 量级的总自由度 |
| **计算开销低** | 正交矩阵生成（QR 分解）耗时毫秒级，相比 ODE 求解可忽略 |
| **通用兼容** | 可应用于任何 Flow / Diffusion 预训练模型 |

### 4.2 与现有方法的对比

| | DiffPure | DensePure | 本方案 (ROPF) |
|--|----------|-----------|--------------|
| 需要训练 | 否 | 否 | 否 |
| 修改 ODE 轨迹 | 否 | 否（多次采样） | 是（正交折叠） |
| 随机性来源 | SDE 高斯噪声 | 多次随机采样 + 投票 | 高维正交变换 |
| 随机性维度 | 低（与噪声维度相同） | 中（采样次数） | 高（$10^6 \sim 10^7$ 自由度） |
| 抗 EOT 能力 | 弱 | 中 | 强（计算代价指数级增长） |
| Clean Acc 损失 | 有（SDE 噪声模糊图像） | 有（多次采样取多数投票） | 理论上无（保距变换） |
| 推理额外开销 | 无 | 高（多次完整去噪） | 极低（仅 QR 分解 + 矩阵乘法） |

### 4.3 已知局限性

1. **非理论绝杀**：EOT 的期望梯度在理论上是良定义的（因为损失函数有界）。我们的防御论点建立在**计算复杂度**而非**理论不可能性**上。
2. **黑盒迁移攻击**：本方案主要针对白盒梯度攻击。对于不依赖本地梯度的黑盒迁移攻击（使用替代模型生成对抗样本），正交变换不提供额外防御。但 Flow 模型本身的重建能力对此类攻击仍有一定鲁棒性。
3. **Patch 边界效应**：Patch-wise 分块变换在 patch 边界处不保证空间连续性。虽然这不影响数学正确性（因为 $R^T R = I$ 保证了完美重建），但可能需要在实验中验证是否对净化质量有微小影响。

---

## 5. 推荐实验配置

### 5.1 最小可行实验（验证核心假设）

**数据集**：CIFAR-10

**模型**：预训练 Rectified Flow（CIFAR-10）

**Patch 配置**：$p = 4$，$d = 48$，每 patch 自由度 1128，共 64 个 patch

**跳跃配置**：$K = 5$ 次跳跃，均匀分布在 $[t_{start}, 0]$

**ODE 求解**：Euler 法，20 步

**评估指标**：
1. Clean Accuracy（无攻击时的分类准确率）
2. Robust Accuracy under PGD-20（$\ell_\infty$, $\epsilon = 8/255$）
3. Robust Accuracy under AutoAttack
4. EOT 收敛曲线：$N_{EOT} \in \{1, 10, 50, 100, 500, 1000\}$ vs 攻击成功率

### 5.2 关键消融实验

| 实验 | 变量 | 目的 |
|------|------|------|
| Patch 大小 | $p \in \{2, 4, 8, 16\}$ | 验证维度与安全性的关系 |
| 跳跃次数 | $K \in \{1, 3, 5, 10, 20\}$ | 验证跳跃次数对防御效果的影响 |
| 无正交变换 | $\mathcal{R}_k = \mathcal{I}$（退化为标准 DiffPure） | 基线对比 |
| 仅正交变换无跳跃 | $K = 1$（全程使用同一个 $\mathcal{R}$） | 分离跳跃的贡献 |

### 5.3 Adaptive Attack 实验（最重要）

为验证本方案不是 gradient obfuscation，必须实现以下自适应攻击：

1. **BPDA Attack**：攻击者用 $\mathcal{R}_k = \mathcal{I}$ 近似所有正交变换，直接对原始 Flow ODE 反向传播
2. **EOT Attack**：攻击者对正交变换采样 $N$ 次求期望梯度
3. **BPDA + EOT**：结合以上两种策略
4. **Transfer Attack**：用无防御的替代模型生成对抗样本，直接攻击防御系统

**期望结果**：
- BPDA：攻击成功率显著低于无防御基线（因为梯度方向错误）
- EOT：攻击成功率随 $N$ 增加缓慢上升，但在合理 $N$（如 $\leq 1000$）内远低于 100%
- Transfer：攻击成功率取决于 Flow 模型本身的重建能力，与正交变换无关

---

## 6. 存储与计算开销估算

### 6.1 正交矩阵存储

| 配置（$3 \times 256 \times 256$ 图像） | 单个矩阵大小 | 所有 patch 矩阵总大小 | $K=5$ 次跳跃总大小 |
|---------------------------------------|------------|--------------------|--------------------|
| $p=4$, $d=48$ | 9 KB | 36 MB | 180 MB |
| $p=8$, $d=192$ | 144 KB | 144 MB | 720 MB |
| $p=16$, $d=768$ | 2.3 MB | 589 MB | 2.9 GB |

**推荐**：$p=8$ 配置在 4090（24GB）上完全可行。

### 6.2 推理时间开销

| 操作 | 耗时估计 |
|------|---------|
| 正交矩阵生成（QR 分解 × $K \times M$） | ~10 ms |
| 每步正交变换（矩阵乘法 × 2） | ~1 ms |
| 每步网络前向传播 $v_\theta$ | ~50-100 ms |
| **总额外开销（相比标准 Flow purification）** | **< 5%** |

---

*本方案为纯推理时即插即用的防御模块，可零成本应用于任何预训练的 Flow / Diffusion 生成模型。*