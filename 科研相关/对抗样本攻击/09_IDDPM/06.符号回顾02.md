定义公式 (Eq. 9) 为什么是这个样子的

---

这是一个非常硬核但又非常美妙的推导。这个公式不是拍脑袋想出来的，而是通过**贝叶斯公式（Bayes' Theorem）**严格推导出来的解析解。

要理解为什么是这个样子，我们不需要写出繁琐的整个高斯分布表达式，只需要关注**高斯分布性质的一个核心技巧：精度的加法**。

让我们一步步拆解它的来源。

---

### 1. 我们的目标
我们现在的场景是：
1.  我们知道当前的噪音图 $x_t$。
2.  上帝告诉了我们原图 $x_0$。
3.  我们要推断中间那一帧 $x_{t-1}$ 的分布：$q(x_{t-1} | x_t, x_0)$。

根据贝叶斯公式：
$$ q(x_{t-1} | x_t, x_0) = \frac{q(x_t | x_{t-1}, x_0) \cdot q(x_{t-1} | x_0)}{q(x_t | x_0)} $$

根据马尔可夫链性质，$q(x_t | x_{t-1}, x_0)$ 其实就是 $q(x_t | x_{t-1})$（只跟前一步有关）。所以：
$$ \text{后验分布} \propto \underbrace{q(x_t | x_{t-1})}_{\text{前向一步}} \cdot \underbrace{q(x_{t-1} | x_0)}_{\text{从原图跳步}} $$

### 2. 把高斯分布摆出来
这两个分布都是高斯分布（我们只关注方差项）：

1.  **因子 A ($x_t$ 从 $x_{t-1}$ 来):**
    $$ q(x_t | x_{t-1}) = \mathcal{N}(x_t; \sqrt{\alpha_t} x_{t-1}, \beta_t \mathbf{I}) $$
    这也意味着 $x_t = \sqrt{\alpha_t} x_{t-1} + \epsilon$。如果反过来看 $x_{t-1}$ 的分布，这里的方差贡献涉及 $\beta_t$。

2.  **因子 B ($x_{t-1}$ 从 $x_0$ 来):**
    $$ q(x_{t-1} | x_0) = \mathcal{N}(x_{t-1}; \sqrt{\bar{\alpha}_{t-1}} x_0, (1 - \bar{\alpha}_{t-1}) \mathbf{I}) $$
    这里的方差是 $1 - \bar{\alpha}_{t-1}$。

### 3. 高斯乘法法则（核心推导）
两个高斯分布乘积依然是高斯分布。其**新的精度（Precision，方差的倒数）**等于两个分量精度的和。

但在我们这里，变量是 $x_{t-1}$。我们需要看指数部分关于 $x_{t-1}^2$ 的系数。

*   **来自因子 A 的指数项：**
    $$ \exp \left( -\frac{(x_t - \sqrt{\alpha_t}x_{t-1})^2}{2\beta_t} \right) $$
    展开平方项，关于 $x_{t-1}^2$ 的部分是：$\frac{\alpha_t x_{t-1}^2}{2\beta_t}$。
    所以这部分的“精度贡献”是 **$\frac{\alpha_t}{\beta_t}$**。

*   **来自因子 B 的指数项：**
    $$ \exp \left( -\frac{(x_{t-1} - \dots)^2}{2(1-\bar{\alpha}_{t-1})} \right) $$
    关于 $x_{t-1}^2$ 的部分是：$\frac{x_{t-1}^2}{2(1-\bar{\alpha}_{t-1})}$。
    所以这部分的“精度贡献”是 **$\frac{1}{1-\bar{\alpha}_{t-1}}$**。

**现在，我们把精度相加，得到后验分布总精度 $\frac{1}{\tilde{\beta}_t}$：**

$$ \frac{1}{\tilde{\beta}_t} = \frac{\alpha_t}{\beta_t} + \frac{1}{1 - \bar{\alpha}_{t-1}} $$

### 4. 代数变形（见证奇迹的时刻）
现在我们只需要做通分运算，就能得到那个公式。

1.  **通分：**
    $$ \frac{1}{\tilde{\beta}_t} = \frac{\alpha_t(1 - \bar{\alpha}_{t-1}) + \beta_t}{\beta_t(1 - \bar{\alpha}_{t-1})} $$

2.  **利用定义 $\beta_t = 1 - \alpha_t$ 展开分子：**
    $$ \text{分子} = \alpha_t - \alpha_t\bar{\alpha}_{t-1} + (1 - \alpha_t) $$
    $$ \text{分子} = 1 - \alpha_t\bar{\alpha}_{t-1} $$

3.  **利用定义 $\bar{\alpha}_t = \alpha_t \bar{\alpha}_{t-1}$：**
    $$ \text{分子} = 1 - \bar{\alpha}_t $$

4.  **代回原式：**
    $$ \frac{1}{\tilde{\beta}_t} = \frac{1 - \bar{\alpha}_t}{\beta_t(1 - \bar{\alpha}_{t-1})} $$

5.  **取倒数，得到最终结果：**
    $$ \tilde{\beta}_t = \frac{1 - \bar{\alpha}_{t-1}}{1 - \bar{\alpha}_t} \beta_t $$

### 5. 物理含义解读：为什么长这样？

看着这个公式，我们可以读出很有趣的物理意义：

$$ \tilde{\beta}_t = \underbrace{\beta_t}_{\text{前向加噪的单步方差}} \times \underbrace{\frac{1 - \bar{\alpha}_{t-1}}{1 - \bar{\alpha}_t}}_{\text{修正系数 (<1)}} $$

*   **直观理解：**
    逆向过程的方差 $\tilde{\beta}_t$，实际上就是前向过程的方差 $\beta_t$，被一个系数给“缩小”了。
    为什么缩小了？因为在推导 $\tilde{\beta}_t$ 时，我们**不仅知道上一时刻的信息，还作弊偷看了答案 $x_0$**。因为知道了最终答案，不确定性自然就比“瞎走”的 $\beta_t$ 要小。

*   **极值检查（Sanity Check）：**
    当 $t=1$ 时（即最后回到原图的一步）：
    *   $\bar{\alpha}_{t-1} = \bar{\alpha}_0 = 1$ (假设原图没有噪声)。
    *   此时分子 $1 - \bar{\alpha}_{t-1} = 0$。
    *   导致 $\tilde{\beta}_1 = 0$。
    *   **含义：** 如果你已经在 $x_1$ 且知道了 $x_0$，那你回到 $x_0$ 这一步是确定的（方差为0），没有随机性。这完美符合逻辑！

所以，这个复杂的公式其实准确地描述了**在已知 $x_0$ 约束下，逆向一步所剩的“残余不确定性”**。