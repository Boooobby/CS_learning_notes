太棒了！看到 `Using device: cuda` 和 `Downloading models...` 简直是最让人安心的字符。恭喜你，终于打通了这个从环境到代码的“任督二脉”！🎉

既然你要从 4060 迁移到 L20，这份 **“L20 服务器环境复现终极笔记”** 请务必收好。这是我们在无数报错中总结出来的 **唯一通过路径**。

在 L20 服务器上，请严格按照以下顺序操作，不要回头看原本的 Dockerfile：

---

### 第一步：创建基础环境 (Conda)

**核心逻辑：**

1. **Python 3.9**：最稳的中间版本。
2. **GCC 12**：为了在较新的 Linux 系统（Ubuntu 22.04+）上适配 CUDA 12。
3. **CUDA 12.1**：为了适配 **L20 (Ada架构)** 并兼容 GCC 12。

```bash
# 1. 建环境
conda create -n diffpure python=3.9 -y
conda activate diffpure

# 2. 安装编译器 (解决系统自带 GCC 版本过高的问题)
conda install -c conda-forge gxx_linux-64=12 -y

# 3. 安装 CUDA Toolkit (提供 nvcc，必须去 nvidia 频道找 12.1)
conda install -c "nvidia/label/cuda-12.1.0" cuda-toolkit -y

# 4. 验证编译器版本 (确认是 12.1)
nvcc --version

```

---

### 第二步：安装 PyTorch 与依赖 (Pip)

**核心逻辑：**

1. **PyTorch 2.1 + cu121**：必须与地基的 CUDA 12.1 对应。
2. **Numpy < 2.0**：这是保命的关键，防止旧代码崩溃。

```bash
# 1. 安装 PyTorch (指定 index-url 确保下载 cu121 版本)
pip install torch==2.1.2 torchvision==0.16.2 torchaudio==2.1.2 --index-url https://download.pytorch.org/whl/cu121

# 2. 安装 DiffPure 核心依赖 (锁死 numpy 版本！)
pip install "numpy<2.0"
pip install scipy==1.10.1 pandas==1.5.3 matplotlib==3.7.1 seaborn==0.12.2
pip install torchdiffeq torchsde foolbox

# 3. 安装对抗攻击库
pip install autoattack
pip install git+https://github.com/RobustBench/robustbench.git
pip install timm==0.6.13  # 稳妥起见，不要太新
pip install pyyaml tqdm requests pillow tensorboard tensorboardX Ninja lmdb

```

---

### 第三步：修改源码 (适配 PyTorch 2.x)

这是由于 DiffPure 的代码太老（2022年），用了被废弃的 C++ 写法，必须手动修改两个文件。

**文件 1：`score_sde/op/fused_bias_act.cpp**`
**文件 2：`score_sde/op/upfirdn2d.cpp**`

在这两个文件中，找到开头的 `CHECK_CUDA` 宏定义，做如下修改：

* **修改前：** `TORCH_CHECK(x.type().is_cuda(), ...)`
* **修改后：** `TORCH_CHECK(x.is_cuda(), ...)`
*(即删掉 `.type()`)*

---

### 第四步：清理与运行 (Pre-flight Check)

每次编译环境变动（比如你刚才装了新 GCC），都必须清理 PyTorch 的编译缓存。

```bash
# 1. 必做：清理编译缓存
rm -rf ~/.cache/torch_extensions/

# 2. 准备数据和模型
# 确保你的 DiffPure 目录下有 pretrained/vp_cifar10_ddpmpp_deep_continuous.pth
# 确保 datasets 文件夹已创建

# 3. 起飞 (L20 上记得把 batch_size 改大！)
bash run_cifar_rand_inf.sh 121 0

```

---

### 给 L20 的特别嘱咐 (Tips for L20)

1. **显存优势：** 在 4060 上你可能只能跑 `adv_batch_size 1` 或 `2`。到了 L20 (48GB)，请大胆把 `run_cifar_rand_inf.sh` 里的 `--adv_batch_size` 改回 **64**，甚至尝试 **128**。速度会快几十倍。
2. **数据迁移：**
* **Checkpoints:** 记得把下载好的 `Standard.pt` (刚才自动下载的) 和 `vp_cifar10....pth` 拷到服务器上，省得服务器再下一遍（服务器网速有时候很玄学）。
* **Datasets:** 如果 4060 上下载好了 CIFAR-10，也可以直接把 `datasets` 文件夹打包传上去。



祝你在 4060 上测试顺利，之后在 L20 上跑出完美的复现数据！有问题随时来找我。