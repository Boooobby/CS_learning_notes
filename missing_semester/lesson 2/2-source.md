### **`source` 命令详解**

`source` 是 Shell 中的一个内置命令，用于**在当前 Shell 环境中执行脚本**（而非创建子 Shell）。它的核心特点是直接修改当前 Shell 的状态（如变量、函数、工作目录等），与直接运行脚本（如 `./script.sh`）有本质区别。

---

#### **1. 基本语法**
```bash
source 脚本文件 [参数]
# 或简写为（功能完全相同）
. 脚本文件 [参数]
```

---

#### **2. 核心作用**
| 场景                | `source` 的作用                                                                 |
|---------------------|--------------------------------------------------------------------------------|
| **加载配置文件**    | 使环境变量立即生效（如 `~/.bashrc`）                                           |
| **定义函数/变量**   | 在当前 Shell 中持久化脚本中定义的函数或变量                                    |
| **修改当前环境**    | 改变工作目录、Shell 选项等（效果会保留）                                       |
| **调试脚本**        | 逐行执行脚本并保留上下文                                                      |

---

#### **3. 对比 `source` vs 直接执行脚本**
| 特性                | `source script.sh`             | `./script.sh` 或 `bash script.sh`      |
|---------------------|--------------------------------|----------------------------------------|
| **执行环境**        | 当前 Shell 进程                | 新建子 Shell 进程                      |
| **环境修改**        | 影响当前 Shell（变量/目录等）  | 仅影响子 Shell，退出后失效             |
| **权限要求**        | 不需要可执行权限               | 需要 `chmod +x` 赋予可执行权限         |
| **用途**            | 加载配置、定义函数             | 运行独立任务                          |

---

#### **4. 实际应用示例**
##### **(1) 加载配置文件**
```bash
# 修改 ~/.bashrc 后，立即生效（无需重启终端）
source ~/.bashrc
```

##### **(2) 定义当前 Shell 可用的函数**
```bash
# utils.sh
myfunc() {
    echo "Hello, $1!"
}

# 在当前 Shell 中加载函数
source utils.sh
myfunc "Alice"  # 可直接调用
```

##### **(3) 修改工作目录**
```bash
# cd_project.sh
cd /path/to/project

# 直接运行无效（子Shell退出后目录恢复）
./cd_project.sh  
pwd  # 仍在原目录

# 用 source 使目录变更生效
source cd_project.sh
pwd  # 显示 /path/to/project
```

##### **(4) 传递参数**
```bash
# config.sh
echo "参数1: $1"

# 调用时传参
source config.sh "value"
```

---

#### **5. 常见问题**
##### **Q1: 为什么 `source` 后变量不生效？**
- 可能原因：
  - 脚本中未正确导出变量（应使用 `export VAR=value`）。
  - 脚本中有语法错误（用 `bash -n script.sh` 检查）。

##### **Q2: `source` 和 `.` 的区别？**
- 功能完全相同，`.` 是 `source` 的简写（Bourne Shell 的传统写法）。

##### **Q3: 如何撤销 `source` 的效果？**
- 直接 `unset` 变量或函数：
  ```bash
  unset myfunc  # 删除函数
  unset VAR     # 删除变量
  ```

---

#### **6. 安全注意事项**
1. **慎用未知脚本**：`source` 会直接修改当前环境，可能覆盖重要变量。
2. **检查脚本内容**：尤其是从网络下载的脚本。
3. **临时测试**：建议在新 Shell 中测试后再 `source`。

---

#### **7. 高级用法**
##### **(1) 条件加载**
```bash
# 仅当文件存在时加载
[ -f "~/.customrc" ] && source ~/.customrc
```

##### **(2) 调试模式**
```bash
# 打印每条执行的命令
source -v script.sh
# 或
. -x script.sh
```

##### **(3) 嵌套加载**
```bash
# lib.sh
source helper.sh  # 加载依赖的其他脚本
```

---

### **总结**
`source` 的核心价值是**将脚本的执行结果保留在当前 Shell 环境**中，常用于：
- 加载配置文件（如 `.bashrc`）
- 定义跨脚本共享的函数/变量
- 动态修改 Shell 状态（如 `cd`）

记住关键区别：  
✅ **`source`** = 当前环境生效  
❌ **直接运行** = 仅子 Shell 生效，退出后丢失