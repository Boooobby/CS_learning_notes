### **f-string 的求值机制：是否在花括号内评估后调用 `str()`？**

**是的！**  
在 Python 的 f-string 中，花括号 `{}` 内的表达式会**先被求值**，然后**自动调用 `str()`** 转换为字符串，最后嵌入到最终字符串中。这是 f-string 的核心行为。

---

### **1. 具体执行步骤**
当解析 f-string 时，Python 会按以下顺序处理：
1. **求值表达式**：计算 `{}` 内的表达式（如变量、运算、函数调用等）。
2. **隐式调用 `str()`**：将结果转换为字符串（无需手动调用）。
3. **嵌入字符串**：将转换后的字符串插入到 f-string 的对应位置。

#### **示例验证**
```python
class Demo:
    def __str__(self):
        return "This is __str__"
    def __repr__(self):
        return "This is __repr__"

obj = Demo()
print(f"{obj}")  # 输出: This is __str__
```
这里 `f"{obj}"` 调用了 `obj.__str__()`，而非 `__repr__`，证明 f-string 默认使用 `str()` 转换。

---

### **2. 关键细节**
#### **2.1 显式调用 `repr()`**
如果需要在 f-string 中使用 `repr()`，可以手动调用：
```python
s = "hello"
print(f"{s!r}")  # 输出: 'hello'（等价于 repr(s)）
```
- `!r` 表示调用 `repr()`，`!s` 表示调用 `str()`（默认行为），`!a` 表示调用 `ascii()`。

#### **2.2 非字符串类型的处理**
即使表达式返回非字符串类型（如 `int`、`list`），f-string 也会自动转换：
```python
num = 42
lst = [1, 2, 3]
print(f"{num} is {type(num)}, {lst} is {type(lst)}")
# 输出: 42 is <class 'int'>, [1, 2, 3] is <class 'list'>
```

#### **2.3 性能优化**
由于 f-string 在编译时已确定大部分结构，且直接调用 `str()`，其性能优于其他格式化方法（如 `%` 或 `.format()`）。

---

### **3. 与 `str.format()` 的对比**
| 特性                | f-string                          | `str.format()`                   |
|---------------------|-----------------------------------|----------------------------------|
| **求值时机**        | 编译时确定结构，运行时求值并转换  | 运行时解析格式字符串             |
| **隐式转换**        | 自动调用 `str()`                  | 需手动调用 `str()` 或指定格式    |
| **灵活性**          | 直接嵌入表达式                    | 依赖位置或关键字参数             |

#### **示例对比**
```python
# f-string
name = "Alice"
print(f"{name.upper()}")  # 直接调用方法

# str.format()
print("{}".format(name.upper()))  # 需提前计算或嵌套调用
```

---

### **4. 特殊情况处理**
#### **4.1 自定义类的 `__str__`**
如果类未定义 `__str__`，f-string 会回退到 `__repr__`：
```python
class Foo:
    def __repr__(self):
        return "This is __repr__"

print(f"{Foo()}")  # 输出: This is __repr__
```

#### **4.2 空值处理**
`None` 或其他空值会转换为字符串 `"None"`：
```python
print(f"{None}")  # 输出: None
```

---

### **5. 总结**
- **f-string 的 `{}` 内表达式会先求值，再通过 `str()` 转换为字符串**。
- 可通过 `!r`、`!s`、`!a` 显式指定转换方式。
- **性能优势**：比传统格式化方法更快，代码更简洁。
- **最佳实践**：优先用 f-string（Python 3.6+），复杂格式用 `:` 控制（如 `{num:.2f}`）。