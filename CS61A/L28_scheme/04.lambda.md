好的，我们来深入探讨 Scheme 中极其重要的 `lambda` 表达式。这是函数式编程的核心概念，也是 Scheme 强大能力的源泉。

## 1. Lambda 的基本概念

`lambda` 用于创建**匿名函数**——即没有名字的函数。它源于阿隆佐·邱奇的 λ 演算，是函数式编程的理论基础。

### 基本语法
```scheme
(lambda (parameters) body)
```
- `parameters`: 形式参数列表
- `body`: 函数体，由一个或多个表达式组成

## 2. 基本用法示例

### 创建简单函数
```scheme
;; 创建一个平方函数
(lambda (x) (* x x))

;; 创建加法函数
(lambda (a b) (+ a b))

;; 创建无参数函数
(lambda () (display "Hello!"))
```

### 立即调用 Lambda
```scheme
;; 创建并立即调用
((lambda (x) (* x x)) 5)  ; → 25

;; 多参数立即调用
((lambda (a b c) (+ a b c)) 1 2 3)  ; → 6
```

## 3. Lambda 与 Define 的关系

### 等价的函数定义
```scheme
;; 方式1: 使用 define 的语法糖
(define (square x) (* x x))

;; 方式2: 使用 lambda 的显式定义
(define square (lambda (x) (* x x)))

;; 两者完全等价！
(square 4)  ; → 16
```

### 为什么需要 lambda？
`define` 会给函数命名，而 `lambda` 创建的是匿名函数，可以直接传递和使用，无需命名。

## 4. Lambda 的参数类型

### 固定参数
```scheme
(lambda (x y z) (+ x y z))  ; 必须提供3个参数
```

### 可变参数（剩余参数）
```scheme
;; 接收任意数量的参数
(lambda args (apply + args))          ; 所有参数作为列表
((lambda args (length args)) 1 2 3)   ; → 3

;; 固定参数 + 剩余参数
(lambda (x y . rest) 
  (list x y rest))                    ; rest 是剩余参数的列表
((lambda (x y . z) (list x y z)) 1 2 3 4 5)  ; → (1 2 (3 4 5))
```

## 5. Lambda 的闭包特性

这是 `lambda` 最强大的特性之一：**闭包**可以捕获和记住创建时的环境。

### 创建计数器
```scheme
(define (make-counter)
  (let ((count 0))
    (lambda ()
      (set! count (+ count 1))
      count)))

(define counter1 (make-counter))
(define counter2 (make-counter))

(counter1)  ; → 1
(counter1)  ; → 2
(counter2)  ; → 1 (独立的计数器)
(counter1)  ; → 3
```

### 创建函数工厂
```scheme
(define (make-adder n)
  (lambda (x) (+ x n)))

(define add5 (make-adder 5))
(define add10 (make-adder 10))

(add5 3)   ; → 8
(add10 3)  ; → 13
```

## 6. Lambda 在高阶函数中的应用

### 作为参数传递
```scheme
;; map 接受一个函数和一个列表
(map (lambda (x) (* x x)) '(1 2 3 4))  ; → (1 4 9 16)

;; filter 接受一个谓词函数
(filter (lambda (x) (> x 5)) '(3 8 1 6 2))  ; → (8 6)

;; sort 接受比较函数
(sort (lambda (a b) (< (car a) (car b))) 
      '((3 "c") (1 "a") (2 "b")))  ; → ((1 "a") (2 "b") (3 "c"))
```

### 作为返回值
```scheme
(define (compose f g)
  (lambda (x) (f (g x))))

(define square-inc (compose square add1))
(square-inc 4)  ; → 25 = (4+1)²
```

## 7. Lambda 的函数体

Lambda 的函数体可以包含多个表达式，返回最后一个表达式的值：

```scheme
(lambda (x)
  (display "Calculating square of ")
  (display x)
  (newline)
  (* x x))  ; 这是返回值

;; 立即调用演示
((lambda (x)
   (display "Processing: ")
   (display x)
   (newline)
   (* x 2)) 5)
;; 输出: Processing: 5
;; 返回: 10
```

## 8. 实用的 Lambda 模式

### 回调函数
```scheme
(define (process-data data callback)
  (display "Processing data...")
  (newline)
  (callback data))

(process-data '(1 2 3) 
              (lambda (lst) (map square lst)))  ; → (1 4 9)
```

### 事件处理器
```scheme
(define (on-click handler)
  (display "Button clicked!")
  (handler))

(on-click (lambda () 
            (display "Handling click event")
            (newline)))
```

### 配置函数
```scheme
(define (create-person name age . options)
  (let ((options-alist options))
    (lambda (message)
      (case message
        ((get-name) name)
        ((get-age) age)
        ((get-option) 
         (lambda (key) (assoc key options-alist)))
        (else (error "Unknown message")))))

(define john (create-person "John" 25 'city "NY" 'job "Engineer"))
(john 'get-name)  ; → "John"
((john 'get-option) 'city)  ; → (city "NY")
```

## 9. Lambda 与词法作用域

Lambda 捕获的是**词法作用域**中的变量：

```scheme
(let ((x 10))
  (define get-x (lambda () x))
  (define set-x (lambda (new-x) (set! x new-x)))
  (list get-x set-x))

(define my-get (car (let...)))
(define my-set (cadr (let...)))

(my-get)  ; → 10
(my-set 20)
(my-get)  ; → 20
```

## 10. Lambda 的性能考虑

虽然 lambda 很强大，但需要注意：

```scheme
;; 在循环中重复创建相同的 lambda 可能低效
(define (process-list lst)
  (map (lambda (x) (* x x)) lst))  ; 每次调用都创建新函数

;; 更好的方式：预先定义
(define square (lambda (x) (* x x)))
(define (process-list lst)
  (map square lst))  ; 复用同一个函数
```

## 总结：Lambda 的重要性

| 特性 | 说明 |
|------|------|
| **匿名性** | 创建不需要命名的函数 |
| **一等公民** | 函数可以作为参数、返回值、存储在数据结构中 |
| **闭包** | 捕获创建时的环境，记住状态 |
| **灵活性** | 支持固定参数、可变参数等各种形式 |
| **表达力** | 使代码更简洁、更声明式 |
| **函数式编程基础** | 实现高阶函数、柯里化、组合等模式 |

`lambda` 不仅仅是创建函数的语法，它代表了 Scheme 的核心哲学：**代码即数据，函数即值**。掌握 `lambda` 是真正理解函数式编程和 Scheme 强大表达能力的关键。